<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upload Waste Image</title>
  <link rel="stylesheet" href="upload.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-logo">  <a href="https://himvillageprahari.org" target="_blank" rel="noopener noreferrer">
    Him Village EPrahari
  </a></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="certificate.html">Certificate</a></li>
    </ul>
  </nav>

  <div class="main-content">


    <section class="hero-section">

    <h2>Capture / Upload Waste Image</h2>

    <div id="userStatus">Please login from Home page</div>

    <label>
      Choose category:
      <select id="category">
        <option value="">--select--</option>
        <option value="plastic">Plastic</option>
        <option value="metal">Metal</option>
        <option value="glass">Glass</option>
        <option value="paper">Paper</option>
        <option value="cardboard">Cardboard</option>
        <option value="trash">Trash</option>
      </select>
    </label>

    <div id="inputContainer">
      <!-- Will dynamically show either camera or file input -->
    </div>

    <button id="uploadBtn">Upload</button>

    <div id="status"></div>
    <progress id="progressBar" value="0" max="100" style="display:none;"></progress>

    <h3>Your Progress:</h3>
    <div id="progressDisplay">Loading...</div>


    </section>
    <i>Note: The images and state location information you provided are used only for technical research and improving our digital waste awareness initiatives.</i>


  </div>

<script src="env.js"></script>
<script type="module" src="firebase-config.js"></script>
<script type="module">
import {
  auth, onAuthStateChanged, db, collection, addDoc, serverTimestamp,
  doc, updateDoc, increment, getDoc
} from './firebase-config.js';

const userStatus = document.getElementById('userStatus');
const uploadBtn = document.getElementById('uploadBtn');
const inputContainer = document.getElementById('inputContainer');
const categorySel = document.getElementById('category');
const statusDiv = document.getElementById('status');
const progressBar = document.getElementById('progressBar');
const progressDisplay = document.getElementById('progressDisplay');

let currentUser = null;
let selectedFile = null;
let userState = ''; // Geo state

// ---------------- DEVICE DETECTION ----------------
function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);
}

function createInput() {
  inputContainer.innerHTML = '';
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  if (isMobile()) fileInput.capture = 'environment';
  fileInput.id = 'fileInput';
  inputContainer.appendChild(fileInput);
  fileInput.addEventListener('change', e => selectedFile = e.target.files[0]);
}

// ---------------- GEOLOCATION ----------------
async function getState() {
  if (!navigator.geolocation) return '';
  return new Promise(resolve => {
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await res.json();
      resolve(data.address.state || '');
    }, err => resolve(''));
  });
}

// ---------------- PROGRESS DISPLAY ----------------
async function updateProgressDisplay() {
  if (!currentUser) return;
  const userRef = doc(db, 'users', currentUser.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    progressDisplay.textContent = "No progress yet.";
    return;
  }

  const data = userSnap.data();
  const categories = ["plastic","metal","glass","paper","cardboard","trash"];
  let html = "";
  let allUploadsDone = true;
  categories.forEach(cat => {
    const count = data.progress?.[cat] || 0;
    html += `${cat.charAt(0).toUpperCase() + cat.slice(1)}: ${count}/2 <br>`;
    if (count < 2) allUploadsDone = false;
  });
  progressDisplay.innerHTML = html;

  // Show certificate section if both uploads per category & module done
  const moduleDone = data.moduleCompleted || false;
  showCertificateIfEligible(allUploadsDone, moduleDone);
}

// ---------------- SHOW CERTIFICATE IF ELIGIBLE ----------------
function showCertificateIfEligible(uploadsDone, moduleDone) {
  let existing = document.getElementById('certificateSection');
  if (uploadsDone && moduleDone) {
    if (!existing) {
      const certDiv = document.createElement('div');
      certDiv.id = 'certificateSection';
      certDiv.style.marginTop = '20px';
      certDiv.innerHTML = `
        <h3>Congratulations! ðŸŽ‰ You are eligible for your certificate!</h3>
        <button id="getCertificateBtn" class="button">Get Certificate</button>
      `;
      progressDisplay.parentNode.appendChild(certDiv);
      document.getElementById('getCertificateBtn').addEventListener('click', () => {
        window.location.href = 'certificate.html';
      });
    }
  } else {
    if (existing) existing.remove();
  }
}

// ---------------- AUTH STATE ----------------
onAuthStateChanged(auth, async user => {
  currentUser = user;
  if (user) {
    userStatus.textContent = `Signed in as ${user.displayName || user.email}`;
    createInput();
    userState = await getState();
    await updateProgressDisplay();
  } else {
    userStatus.textContent = 'Not signed in. Please login on Home page.';
  }
});

// ---------------- IMAGE RESIZE ----------------
function resizeImage(file, maxWidth = 512, maxHeight = 512, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      let width = img.width;
      let height = img.height;
      if (width > height) { if (width > maxWidth) { height = Math.round(height * maxWidth / width); width = maxWidth; } }
      else { if (height > maxHeight) { width = Math.round(width * maxHeight / height); height = maxHeight; } }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      canvas.getContext('2d').drawImage(img, 0, 0, width, height);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

// ---------------- CLOUDINARY UPLOAD ----------------
async function uploadToCloudinary(fileBlob, category) {
  const cloudName = "daqjpvbh6";
  const uploadPreset = "waste_upload";
  const formData = new FormData();
  formData.append("file", fileBlob);
  formData.append("upload_preset", uploadPreset);
  formData.append("folder", category.toLowerCase());

  progressBar.style.display = 'block';
  progressBar.value = 0;
  statusDiv.innerHTML = 'Uploading<span class="dots">...</span>';

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`);
    xhr.upload.onprogress = event => {
      if (event.lengthComputable) progressBar.value = (event.loaded/event.total)*100;
    };
    xhr.onload = () => {
      const data = JSON.parse(xhr.responseText);
      if (data.secure_url) resolve(data.secure_url);
      else reject(new Error("Upload failed"));
    };
    xhr.onerror = () => reject(new Error("Upload failed"));
    xhr.send(formData);
  });
}

// ---------------- UPLOAD BUTTON ----------------
uploadBtn.addEventListener('click', async () => {
  if (!currentUser) return alert('Please login first (Home page).');
  if (!selectedFile) return alert('Please select/capture an image.');
  const category = categorySel.value;
  if (!category) return alert('Please select a category.');

  try {
    const compressedBlob = await resizeImage(selectedFile, 512, 512, 0.8);
    const imageURL = await uploadToCloudinary(compressedBlob, category);

    await addDoc(collection(db, 'uploads'), {
      userId: currentUser.uid,
      category,
      imageURL,
      state: userState,
      timestamp: serverTimestamp()
    });

    const userRef = doc(db, 'users', currentUser.uid);
    await updateDoc(userRef, {
      totalPoints: increment(1),
      [`progress.${category.toLowerCase()}`]: increment(1)
    });

    statusDiv.textContent = 'Upload successful!';
    selectedFile = null;
    inputContainer.querySelector('input').value = '';
    progressBar.style.display = 'none';
    await updateProgressDisplay();
  } catch(err) {
    console.error(err);
    statusDiv.textContent = 'Error: ' + err.message;
    progressBar.style.display = 'none';
  }
});
</script>
</body>
</html>
