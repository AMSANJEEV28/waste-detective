<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upload Waste Image</title>
    <link rel="stylesheet" href="upload.css">

</head>
<body>
      <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-logo">Him Village EPrahari</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="upload.html">Upload</a></li>
      <li><a href="certificate.html">Certificate</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
    </ul>
  </nav>


  <div class="main-content">
  <h2>Upload an Image</h2>

  <div id="userStatus">Please login from Home page</div>

  <label>
    Choose category:
    <select id="category">
      <option value="">--select--</option>
      <option value="plastic">Plastic</option>
      <option value="metal">Metal</option>
      <option value="glass">Glass</option>
      <option value="paper">Paper</option>
      <option value="cardboard">Cardboard</option>
      <option value="trash">Trash</option>
    </select>
  </label>
  <br><br>

  <input type="file" id="fileInput" accept="image/*" />
  <br><br>
  <button id="uploadBtn">Upload</button>

  <div id="status"></div>
  <progress id="progressBar" value="0" max="100" style="display:none;"></progress>

  <h3>Your Progress:</h3>
  <div id="progressDisplay">Loading...</div>


  </div>

  <script type="module">
    import {
      auth, onAuthStateChanged, db, collection, addDoc, serverTimestamp,
      doc, updateDoc, increment, getDoc
    } from './firebase-config.js';

    const userStatus = document.getElementById('userStatus');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const categorySel = document.getElementById('category');
    const statusDiv = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressDisplay = document.getElementById('progressDisplay');

    let currentUser = null;

    // Update progress display
    async function updateProgressDisplay() {
      if (!currentUser) return;
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        progressDisplay.textContent = "No progress yet.";
        return;
      }

      const data = userSnap.data();
      const categories = ["plastic","metal","glass","paper","cardboard","trash"];
      let html = "";

      categories.forEach(cat => {
        const count = data.progress?.[cat] || 0;
        html += `${cat.charAt(0).toUpperCase() + cat.slice(1)}: ${count}/5 <br>`;
      });

      progressDisplay.innerHTML = html;
    }

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        userStatus.textContent = `Signed in as ${user.displayName || user.email}`;
        await updateProgressDisplay();
      } else {
        userStatus.textContent = 'Not signed in. Please login on Home page.';
        progressDisplay.textContent = '';
      }
    });

    // Resize/compress image
    function resizeImage(file, maxWidth = 512, maxHeight = 512, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = Math.round((width * maxHeight) / height);
              height = maxHeight;
            }
          }

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
        };
        img.onerror = err => reject(err);
        img.src = URL.createObjectURL(file);
      });
    }

    // Upload to Cloudinary with folder support
    async function uploadToCloudinary(fileBlob, category) {
      const cloudName = "daqjpvbh6";        // Your Cloudinary cloud name
      const uploadPreset = "waste_upload";  // Unsigned preset

      const formData = new FormData();
      formData.append("file", fileBlob);
      formData.append("upload_preset", uploadPreset);
      formData.append("folder", category.toLowerCase());  // Save in folder based on category

      progressBar.style.display = 'block';
      progressBar.value = 0;

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`);
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            progressBar.value = percent;
            statusDiv.textContent = `Uploading: ${percent.toFixed(1)}%`;
          }
        };
        xhr.onload = () => {
          const data = JSON.parse(xhr.responseText);
          if (data.secure_url) {
            resolve(data.secure_url);
          } else {
            reject(new Error("Cloudinary upload failed: no secure_url returned"));
          }
        };
        xhr.onerror = () => reject(new Error("Cloudinary upload failed"));
        xhr.send(formData);
      });
    }

    // Upload button click
    uploadBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Please login first (go to Home).');

      const file = fileInput.files[0];
      const category = categorySel.value;
      if (!file) return alert('Please select an image file.');
      if (!category) return alert('Please select a category.');

      try {
        statusDiv.textContent = 'Resizing image...';
        const compressedBlob = await resizeImage(file, 512, 512, 0.8);

        const imageURL = await uploadToCloudinary(compressedBlob, category);

        // Save in Firestore
        await addDoc(collection(db, 'uploads'), {
          userId: currentUser.uid,
          category,
          imageURL,
          timestamp: serverTimestamp()
        });

        // Update user progress
        const userRef = doc(db, 'users', currentUser.uid);
        const normalized = category.toLowerCase();
        await updateDoc(userRef, {
          totalPoints: increment(1),
          [`progress.${normalized}`]: increment(1)
        });

        statusDiv.textContent = 'Upload successful!';
        fileInput.value = '';
        progressBar.style.display = 'none';
        await updateProgressDisplay();
      } catch (err) {
        console.error(err);
        statusDiv.textContent = 'Error: ' + err.message;
        progressBar.style.display = 'none';
      }
    });
  </script>
</body>
</html>
