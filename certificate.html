<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Waste Detective - Certificate</title>
    <link rel="stylesheet" href="certificate.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
      <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-logo">Him Village EPrahari</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="upload.html">Upload</a></li>
      <li><a href="certificate.html">Certificate</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
    </ul>
  </nav>


  <div class="main-content">

  <h2>Waste Detective Certificate</h2>
  <div id="userStatus">Loading user info...</div>
  <div id="status">Checking eligibility for certificate...</div>
  <button id="certBtn" disabled>Upload at least 5 images per category to unlock certificate</button>


  </div>
<script src="env.js"></script>
<script type="module" src="firebase-config.js"></script>
<script type="module" src="index.js"></script>
  <script type="module">
    import { auth, onAuthStateChanged, db, doc, getDoc } from './firebase-config.js';

    const userStatus = document.getElementById('userStatus');
    const statusDiv = document.getElementById('status');
    const certBtn = document.getElementById('certBtn');

    let currentUser = null;

    async function checkEligibility() {
      if (!currentUser) return;

      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        const userData = userSnap.data();
        const progress = userData.progress || {};
        const categories = ['plastic', 'metal', 'glass', 'paper', 'cardboard', 'trash'];

        // Check 5 images per category
        // TESTING: just 1 upload in any category unlocks certificate
        // let totalUploads = categories.reduce((sum, cat) => sum + (progress[cat] || 0), 0);
        // let eligible = totalUploads >= 1;
        let eligible = categories.every(cat => (progress[cat] || 0) >= 5);


        if (eligible) {
          certBtn.disabled = false;
          certBtn.textContent = "Download Certificate";
          statusDiv.textContent = "Congratulations! You have uploaded at least 5 images in each category.";
        } else {
          certBtn.disabled = true;
          certBtn.textContent = "Upload at least 5 images per category to unlock certificate";
          statusDiv.textContent = "You need at least 5 images per category to unlock certificate.";
        }
      } else {
        statusDiv.textContent = "User data not found. Upload at least one image first.";
      }
    }

    function generateCertificate(name) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: "landscape",
        unit: "px",
        format: [1040, 720]
    });

    const img = new Image();
    img.src = 'certificate.jpg';
    img.onload = function() {
        doc.addImage(img, 'JPG', 0, 0, 1040, 720);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(30);
        doc.setTextColor(0, 102, 51);
        doc.text(name, 520, 300, { align: "center" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(25);
        doc.text("Be a Waste Detective â€“ Segregate for a Better Future", 520, 400, { align: "center" });

        const today = new Date().toLocaleDateString();
        doc.setFont("helvetica", "italic");
        doc.setFontSize(25);
        doc.text(`Date: ${today}`, 520, 500, { align: "center" });

        doc.save(`WasteDetective_Certificate_${name}.pdf`);
    }
    }



     onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        userStatus.textContent = `Signed in as ${user.displayName || user.email}`;
        checkEligibility();
      } else {
        userStatus.textContent = "Not signed in. Please login from Home page.";
        statusDiv.textContent = "";
      }
    });

    certBtn.addEventListener('click', async () => {
      if (!currentUser) return alert("Please login first.");
      const name = currentUser.displayName || currentUser.email || "Participant";
      generateCertificate(name);
    });
  </script>
</body>
</html>
